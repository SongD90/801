---
title: "Code801"
author: "Marianne Huebner"
date: "August 21, 2016"
output: word_document
---

```{r, echo=FALSE}
setwd("~/Desktop/Teaching/801/Lectures/Rcode")

library(ggplot2)
library(ggthemes)
library(extrafont)
library(graphics)

library(car)

library(xtable)
```


*Most code is based on Christophe Lalanne's R Companion to Montgomery's Design and Analysis of Experiements (2005)*

## Probability distributions

For example, for the F distribution the R code format is \tt{df(x, df1, df2, log = FALSE)} where
\tt{df} gives the density, \tt{pf}  the distribution function, \tt{qf} is 
the quantile function, and \tt{rf} generates random deviates.
```{r, prob}

curve(dnorm(x,0,1), -3,3, ylab="normal density", col="blue")
curve(dnorm(x,1,1), -3,3, col="green", add=TRUE)
curve(dnorm(x,0,2), -3,3, col="red", add=TRUE)

#dt(x, df, ncp=0, log = FALSE)
#pt(q, df, ncp=0, lower.tail = TRUE, log.p = FALSE)
#qt(p, df,        lower.tail = TRUE, log.p = FALSE)
#rt(n, df)

curve(dt(x,10), -3,3, ylab="t density", col="green")
curve(dt(x,1), -3,3, col="blue", add=TRUE)
 legend(1,.35, c("df=10", "df=1"),col=c("green","blue"), lty=1)

#dchisq(x, df, ncp=0, log = FALSE)
curve(dchisq(x,2), 0,30, lty=1, ylab="chisquare density", col="green")
curve(dchisq(x,5),  lty=2, col="blue", add=TRUE)
curve(dchisq(x,10),  lty=3, col="red", add=TRUE)
legend(20,.5, c("df=2","df=5","df=10"),cex=1, col=c("green","blue", "red"), lty=1:3)
```



## Chapter 2: Comparison of two groups


```{r, chap2tension}
set.seed(801)
# Tension Bond Strength data (Tab. 2-1, p. 24)
y1 <- c(16.85,16.40,17.21,16.35,16.52,17.04,16.96,17.15,16.59,16.57)
y2 <- c(16.62,16.75,17.37,17.12,16.98,16.87,17.34,17.02,17.08,17.27)
y <- data.frame(Modified=y1,Unmodified=y2)
y.means <- as.numeric(apply(y,2,mean))
#opar <- par(mfrow=c(2,1),mar=c(5,7,4,2),las=1) 
stripchart(y,xlab=expression("Strength (kgf/cm^2)"),pch=19) 
arrows(y.means,rep(1.5,2),y.means,c(1.1,1.9),length=.1) 
text(y.means,c(1.2,1.8),round(y.means,2),pos=4,cex=.8)
# Random deviates (instead of data from metal recovery used in the book) 
rd <- rnorm(200,mean=70,sd=5)
hist(rd,xlab="quantile",nclass=200, ylab="Relative frequency",
main="Random Normal Deviates\n N(70,5)") 
#par(opar)


boxplot(y,ylab="Strength (kgf/cm^2)",las=1)
```

```{r chap2ttest}
t.test(y1,y2,var.equal=TRUE)
as.numeric(diff(apply(y,2,mean)))
t.test(y1,y2)

qqnorm(y1)
qqline(y1)

```


```{r chap2hardness}
tmp<-c(7,3,3,4,8,3,2,9,5,4,6,3,5,3,8,2,4,9,4,5)
hardness <- data.frame(y = tmp, tip = gl(2,10))
t.test(y ~ tip, data = hardness, paired = TRUE)

with(hardness, plot(y[tip==1],y[tip==2],xlab="Tip 1",ylab="Tip 2"))
  abline(0,1)
  with(hardness, plot(y[tip==1]+y[tip==2],y[tip==1]-y[tip==2],
                      xlab="Tip 1 + Tip 2",ylab="Tip 1 - Tip 2",ylim=c(-3,3)))
abline(h=0)

#ignoring pairing
t.test(y ~ tip, data = hardness, var.equal = TRUE)

#nonparametric
wilcox.test(y1,y2)
wilcox.test(y~tip,data=hardness,paired=TRUE)
```


## Chapter 3: ANOVA - Comparison of multiple groups


**Example**: Unwanted material on silion coated wafers is removed by an etching process. The fiure below visualizes the association of the radio-frequency (RF) power setting with the etch rate.

```{r etchrate}
etch.rate <- read.table("~/Desktop/Teaching/801/Lectures/Rcode/data/etchrate.txt",header=T)
grp.means <- with(etch.rate, tapply(rate,RF,mean))
with(etch.rate, stripchart(rate~RF,vert=T,method="overplot",pch=1, ylab=""));
stripchart(as.numeric(grp.means)~as.numeric(names(grp.means)),pch="x", cex=1.5,vert=T,add=T)
title(main="Etch Rate data",ylab=expression(paste("Observed Etch Rate (",ring(A),"/min)")),xlab="RF Power (W)");
legend("bottomright","Group Means",pch="x",bty="n")
```


Radio-frequency and run are factors in the ANOVA analysis.
```{r aov}
# first, we convert each variable to factor 
etch.rate$RF <- as.factor(etch.rate$RF)
etch.rate$run <- as.factor(etch.rate$run) 
# next, we run the model
etch.rate.aov <- aov(rate~RF,etch.rate) 
summary(etch.rate.aov)
```

```{r lambs}
diet1<-c(8,16,9)
diet2<-c(9,16,21,11,18)
diet3<-c(15,10,17,6)
lambs<-cbind(c(rep(1,3),rep(2,5),rep(3,4)),
+ c(diet1,diet2,diet3))
colnames(lambs)<-c("diet","wtgain")
lambs<-data.frame(lambs)

 lambs$diet<-factor(lambs$diet, labels=c(1,2,3))
 anova(lm(lambs$wtgain ~ factor(lambs$diet)))
```

Plots
```{r lampbsplots}
 stripchart(lambs$wtgain~lambs$diet, vert=T, pch=16)
#pdf(file="~/Desktop/Teaching/801/Lectures/Anova_Chap3/lambs_diagnostics.pdf")
par(mfrow=c(2,2))
plot(lm(lambs$wtgain ~ factor(lambs$diet)))
par(mfrow=c(1,1))
#dev.off()
```

```{r modelcheck}
par(mfrow=c(2,2), cex=0.8)
plot(etch.rate.aov)
par(mfrow=c(1,1))

# for a subset of predictors use individual plots
plot(fitted(etch.rate.aov), residuals(etch.rate.aov))  #residuals
qqnorm(residuals(etch.rate.aov)); qqline(residuals(etch.rate.aov))  #normal qq-plot   

durbinWatsonTest(etch.rate.aov)  #test for independence of residuals
bartlett.test(rate~RF,data=etch.rate)  #test for homoscedasticity (constant variance)
leveneTest(etch.rate.aov)   #test for homogeneity of variances

shapiro.test(etch.rate$rate[etch.rate$RF==160])  #normality in subgroups

shapiro.test(etch.rate$rate)  
```



**Power and sample size for ANOVA models**
```{r power}

grp.means <- c(575,600,650,675) 
power.anova.test(groups=4,between.var=var(grp.means),within.var=25^2,
sig.level=.01,power=.90)


#operating characteristic curve (OCC) = plot power against a parameter
# here a=4, 
# how does sd and sample size influence power?

sd <- seq(20,80,by=2)
nn <- seq(4,20,by=2)
beta <- matrix(NA,nr=length(sd),nc=length(nn))

for (i in 1:length(sd))
      beta[i,] <- power.anova.test(groups=4,n=nn,between.var=var(grp.means),
                  within.var=sd[i]^2,sig.level=.01)$power 

colnames(beta) <- nn; 
rownames(beta) <- sd

matplot(sd,beta,type="l",xlab=expression(sigma),ylab=expression(1-beta),col=1, lty=1)
  grid()
text(rep(80,10),beta[length(sd),],as.character(nn),pos=3) 
title("Operating Characteristic Curve\n for a=4 treatment means")
```

**Multiple Comparisons**

```{r comparison}
#comparison of treatment means
pairwise.t.test(etch.rate$rate,etch.rate$RF,p.adjust.method="bonferroni") 
pairwise.t.test(etch.rate$rate,etch.rate$RF,p.adjust.method="hochberg")

#taking into account inflation of type I error
TukeyHSD(etch.rate.aov) 
plot(TukeyHSD(etch.rate.aov),las=1)
```




